---
title: 'BMI 710: Final Project'
author: 'Author: Cheryl Gu'
date: 'Due: May 5, 2024'
---

# Load libraries
```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(710)
library(Seurat)
library(ggplot2)
library(harmony)
library(data.table)
library(Matrix)
library(presto)
library(dplyr)
library(monocle3)
library(SeuratWrappers)
library(fgsea)
library(msigdbr)
```

# Read the data and create seurat object
```{r}
breast_data<- fread("/n/groups/training/bmi710/project_data/Azizi2018_BreastCancer/GSE114725_rna_raw.csv.gz") 
count_data <- as.matrix(breast_data[, -c(1:5)]) 
cell_ids <- breast_data[[5]]
count_data <- t(count_data)
colnames(count_data) <- cell_ids
breast <- CreateSeuratObject(counts = count_data)
metadata <- breast_data[, 1:5]
rownames(metadata) <- cell_ids
breast <- AddMetaData(breast, metadata = metadata)
dim(breast)
```

# Quality Control
```{r}
#Assess data quality
breast[["percent_mito"]] <- PercentageFeatureSet(breast, pattern = "^MT-")
VlnPlot(breast, features = c("nFeature_RNA", "nCount_RNA", "percent_mito"), ncol = 3)
ggplot(breast[[]], aes(x = nFeature_RNA, y = percent_mito)) + geom_point()
# from the violin plot, we see that MT percentage at around 10% has become tail-shaped which is where we wanna exclude the potentially dying cells.

#QC
breast <- subset(breast, subset = nFeature_RNA > 500 & percent_mito < 10)
dim(breast)
```

# Process the data
```{r}
#Normalize the data
breast <- NormalizeData(breast, normalization.method = "LogNormalize", scale.factor = 10000)

#Find variable features(genes)
breast <- FindVariableFeatures(breast, selection.method = "vst", nfeatures = 2000) 

#Scale the data
breast <- ScaleData(breast, do.scale  = TRUE, do.center = TRUE) 
```

# Dimensionality reduction
```{r}
breast <- RunPCA(breast)
ElbowPlot(breast, ndims = 20, reduction = "pca") #18pc is the flexion point
breast <- RunUMAP(breast, dims = 1:18)
```

# Assess batch effects
```{r}
# check for possible variables that may cause batch effects, plot them on UMAP
DimPlot(breast, group.by = "patient", reduction = "umap")
# replicate IDs alone are not informative, so we need to combine patient ID with replicate
breast$patient_replicate <- paste(breast$patient, breast$replicate, sep = "_")
DimPlot(breast, group.by = "patient_replicate", reduction = "umap")
# we get a similar plot with group by "patient", so only "patient" variable is meaningful for batch correction

# check for T cell marker gene, we found it distributed separately
FeaturePlot(breast, "CD3D", reduction = "umap")
```

# Batch Correction
```{r}
breast <- RunHarmony(breast, "patient")
breast <- RunUMAP(breast, dims = 1:18, reduction = "harmony", reduction.name = "umap_harmony")

# make a new UMAP visualization from the new reduction generated by harmony
DimPlot(breast, reduction = "umap_harmony", group.by = "patient")
FeaturePlot(breast, "CD3D", reduction = "umap_harmony")
# we observe now the clusters are not separated based on batch variables, and the cells expressing the same T cell marker tend to cluster together in the feature plot
```


# Clustering
```{r}
# use the Louvain algorithm run on the batch-corrected PCs
breast <- FindNeighbors(breast, dims = 1:18, reduction = "harmony")
# try various clustering resolutions
breast <- FindClusters(breast, resolution = seq(0.1, 1, 0.1), algorithm = 1)
DimPlot(breast, reduction = "umap_harmony", label = T, group.by = "RNA_snn_res.0.1") # 0.1 resolution works the best
Idents(breast) = "RNA_snn_res.0.1"

# finding differentially expressed genes
top_markers <- FindAllMarkers(breast, logfc.threshold = 1, test.use = "wilcox", only.pos=TRUE)
# look at top markers that have postive log2FCs specifically in each cluster
top_markers %>% filter(cluster == 8 & avg_log2FC > 0) %>% head
top_10_markers <- top_markers %>% group_by(cluster) %>% top_n(n=10, wt = avg_log2FC)
# use heatmap visualizations for top 10 marker genes in each cluster
DoHeatmap(breast, features = top_10_markers$gene)
```

# Annotating clusters

```{r}
# use top marker genes with positive log2FCs from each cluster to determine cell types the cluster best represent
# check by coloring the UMAP by a gene's expression 
# cluster 0 - T cell - MAL
FeaturePlot(breast, features = "MAL", reduction = "umap_harmony")
# cluster 1 - Macrophage - TMEM37
FeaturePlot(breast, features = "TMEM37", reduction = "umap_harmony")
# cluster 2 - NK cell - FGFBP2
FeaturePlot(breast, features = "FGFBP2", reduction = "umap_harmony")
# cluster 3 - B cell - IGHD
FeaturePlot(breast, features = "IGHD", reduction = "umap_harmony")
# cluster 4 - DC - CDKN1C
FeaturePlot(breast, features = "CDKN1C", reduction = "umap_harmony")
# cluster 5 - Mast cell - TPSAB1
FeaturePlot(breast, features = "TPSAB1", reduction = "umap_harmony")
# cluster 6 - pDC - LRRC26
FeaturePlot(breast, features = "LRRC26", reduction = "umap_harmony")
# cluster 7 - T reg - UBE2C
FeaturePlot(breast, features = "UBE2C", reduction = "umap_harmony")
# cluster 8 - monocyte - APOD
FeaturePlot(breast, features = "APOD", reduction = "umap_harmony")

# check by making a violin plot of a gene's expression in each cluster
# cluster 0 - T cell - MAL
VlnPlot(breast, features = "MAL") 
# cluster 1 - Macrophage - TMEM37
VlnPlot(breast, features = "TMEM37") 
# cluster 2 - NK cell - FGFBP2
VlnPlot(breast, features = "FGFBP2") 
# cluster 3 - B cell - IGHD
VlnPlot(breast, features = "IGHD") 
# cluster 4 - DC - CDKN1C
VlnPlot(breast, features = "CDKN1C") 
# cluster 5 - Mast cell - TPSAB1
VlnPlot(breast, features = "TPSAB1") 
# cluster 6 - pDC - LRRC26
VlnPlot(breast, features = "LRRC26") 
# cluster 7 - T reg - UBE2C
VlnPlot(breast, features = "UBE2C") 
# cluster 8 - monocyte - APOD
VlnPlot(breast, features = "APOD")
```

```{txt}
# highlight at least two marker genes per cluster for annotations
Cluster 0 - T cell (MAL, FOXP3, RTKN2)
Cluster 1 - Macrophage (C1QC, TMEM37)
Cluster 2 - NK cell (FGFBP2, KLRF1, MYOM2)
Cluster 3 - B cell (IGHD, PAX5)
Cluster 4 - DC (CDKN1C, GPBAR1, NEURL1)
Cluster 5 - Mast cell (TPSAB1, TPSB2, CTSG)
Cluster 6 - pDC (LRRC26, CLEC4C)
Cluster 7 - T reg (UBE2C, ASPM)
Cluster 8 - Monocyte (APOD, DCN)
```

# Differential abundance testing
```{r}
# Add a cell type column to the metadata
cluster_cell_type <- case_when(
  breast$seurat_clusters == 0 ~ "T cell",
  breast$seurat_clusters == 1 ~ "Macrophage",
  breast$seurat_clusters == 2 ~ "NK cell",
  breast$seurat_clusters == 3 ~ "B cell",
  breast$seurat_clusters == 4 ~ "DC",
  breast$seurat_clusters == 5 ~ "Mast cell",
  breast$seurat_clusters == 6 ~ "pDC",
  breast$seurat_clusters == 7 ~ "T reg",
  breast$seurat_clusters == 8 ~ "Monocyte",
  TRUE ~ "Unknown"
)
breast[["cell_type"]] <- cluster_cell_type
cell_type_counts <- table(breast$cell_type)

# find the most abundant cell type - T cell
print(names(which.max(cell_type_counts)))
```
# Compare T cell abundance in tumor vs. normal tissue
```{r}
t_cell_proportion <- breast@meta.data %>%
  group_by(tissue) %>%
  summarise(
    total_cells = n(),
    cell_type_count = sum(cell_type == "T cell"),
    proportion = cell_type_count / total_cells
  ) %>%
  ungroup()

# plotting the proportion of T cells
ggplot(t_cell_proportion, aes(x = tissue, y = proportion, fill = tissue)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Proportion of T Cells by Tissue",
       y = "Proportion of T Cells",
       x = "Tissue")
# we didn't found much difference in T cell proportion comparing normal vs. tumor tissue, so maybe we need to focus on another cell type
```
# Compare B cell abundance in tumor vs. normal tissue
```{r}
B_cell_proportion <- breast@meta.data %>%
  group_by(tissue) %>%
  summarise(
    total_cells = n(),
    cell_type_count = sum(cell_type == "B cell"),
    proportion = cell_type_count / total_cells
  ) %>%
  ungroup()

# plotting the proportion of T cells
ggplot(B_cell_proportion, aes(x = tissue, y = proportion, fill = tissue)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Proportion of B Cells by Tissue",
       y = "Proportion of B Cells",
       x = "Tissue")
```

# Statistical testing for differential abundance
```{r}
total_B_cells_normal <- sum(breast$cell_type == "B cell" & breast$tissue == "NORMAL")
total_cells_normal <- sum(breast$tissue == "NORMAL")
total_B_cells_tumor <- sum(breast$cell_type == "T cell" & breast$tissue == "TUMOR")
total_cells_tumor <- sum(breast$tissue == "TUMOR")

proportion_table <- matrix(c(total_B_cells_normal, total_cells_normal - total_B_cells_normal,
                        total_B_cells_tumor, total_cells_tumor - total_B_cells_tumor),
                      nrow = 2,
                      dimnames = list(c("Normal", "Tumor"), c("B cells", "Non-B cells")))

# performing Chi-squared test
chi_squared_test <- chisq.test(proportion_table)
print(chi_squared_test)
# p value < 2.2 e-16 shows statistically significant that there is differential abundance in B cells comparing normal vs. tumor tissue
```

# Trajectory analysis
```{r}
# plot the cells by batch-corrected PCs and color the cells by tissue variable 
# 18 pcs is the flexion point from previous elbowplots
DimPlot(breast, reduction = "harmony", group.by = "tissue", label = TRUE, pt.size = 0.5)
```

# Infer a trajectory
```{r}
# make a monocle3 object
breast_cds <- as.cell_data_set(breast)
# Now preprocess with Monocle
breast_cds <- preprocess_cds(breast_cds, num_dim = 18, norm_method = "none")
# correct for batch effects 
breast_cds <- align_cds(breast_cds, alignment_group = "patient")
breast_cds <- reduce_dimension(breast_cds, reduction_method = "UMAP")
# calculate the trajectory
breast_cds <- cluster_cells(breast_cds)
breast_cds <- learn_graph(breast_cds, use_partition = F)
# plot the umap with trajectory by tissue
plot_cells(breast_cds, 
           label_groups_by_cluster=FALSE,  
           color_cells_by = "tissue", 
           reduction_method = "UMAP", 
           group_label_size = 6)
# plot the umap with trajectory by cell type
plot_cells(breast_cds, 
           label_groups_by_cluster=FALSE,  
           color_cells_by = "cell_type", 
           reduction_method = "UMAP", 
           group_label_size = 6)
```

# Calculate pseudotime
```{r, eval=F}
breast_cds <- order_cells(breast_cds)
# a node is chosen from monocyte cell type as starting point, also this region is overlapping with tumor tissue 
png(filename="trajectory_pseudotime_breast.png", width = 10, height = 8, units = 'in', res = 300)
plot_cells(breast_cds, 
           label_groups_by_cluster=FALSE,  
           color_cells_by = "pseudotime", 
           reduction_method = "UMAP", 
           group_label_size = 6)
dev.off()
# we can observe pseudotime is consistebt with the paper describes, as monocytes are differenting from pre-cursor states towards macrophages and pDCs.
```

```{r, out.width="100%"}
knitr::include_graphics("~/bmi710/homework/trajectory_pseudotime_breast.png")
```




```{r}
# plot the monocyte gene signatures to confirm with the trajecory
rowData(breast_cds)$gene_name <- rownames(breast_cds)
rowData(breast_cds)$gene_short_name <- rowData(breast_cds)$gene_name
plot_cells(breast_cds, 
           genes = c("APOD", "DCN", "COL1A1", "CD14"),
           label_groups_by_cluster=FALSE,
           reduction_method = "UMAP",
           show_trajectory_graph = FALSE)
```


